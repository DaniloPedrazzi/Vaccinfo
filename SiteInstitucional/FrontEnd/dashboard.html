<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <!-- ChartJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>

    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/style-dashboard.css">
    <title>VaccInfo | Dashboard</title>

    <!-- Funções pra API -->
    <script src="./js/funcoes.js"></script>
    
    <link rel="website icon" type="png" href="img/mini-logo.png">
</head>

<body onload="validarSessao()">
    <div class="header2">
        <div class="container">
            <img src="./img/logo-vaccinfo.png" alt="">
            <div class="links">
                <div class="link">
                    <a href="./index.html">Home</a>
                </div>
                <div class="link">
                    <a href="fale conosco.html">Fale conosco</a>
                </div>
                <div class="link">
                    <a href="index.html">Sair</a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="main">
        <div class="container">
            <div class="leftSide">
                <!-- <button class="btnRegistrar">Registrar Carga</button> -->
                <div class="boxGrafico">
                    <div class="headerGrafico">
                        <h3>Visão Geral - Semanal</h3>
                    </div>
                    <div class="bodyGrafico">
                        <canvas id="barSemanal"></canvas>
                    </div>
                </div>
            </div>
            <div class="rightSide">
                <div class="boxGrafico">
                    <div class="headerGrafico">
                        <h3>Visão Geral - Diária</h3>
                    </div>
                    <div class="bodyGraficoDiario">
                        <h3 class="qtdLotesTotal">23 <br> Lotes</h3>
                        <canvas id="pieDiaria"></canvas>
                    </div>
                </div>

                <div class="botoes">
                    <a href="cargas.html" class="botao botaoVermelho">
                        <div class="headerBotao">
                            <h3>Crítico</h3>
                            <img height="20px" src="./img/img-exclamacao-icon.png">
                        </div>
                        <h2>3</h2>
                    </a>
                    <a href="cargas.html" class="botao botaoAmarelo">
                        <div class="headerBotao">
                            <h3>Alerta</h3>
                            <img height="20px" src="./img/img-warn-icon.png">
                        </div>
                        <h2>9</h2>
                    </a>
                    <a href="cargas.html" class="botao botaoVerde">
                        <div class="headerBotao">
                            <h3>Ideal</h3>
                            <img height="20px" src="./img/img-check-icon.png">
                        </div>
                        <h2>10</h2>
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>

    var contextobarSemanal = document.getElementById('barSemanal').getContext('2d');
    contextobarSemanal.canvas.width = 600;
    contextobarSemanal.canvas.height = 400;
    var contextopieDiaria = document.getElementById('pieDiaria').getContext('2d');
    contextopieDiaria.canvas.width = 400;
    contextopieDiaria.canvas.height = 200;

    window.onload = obterDadosGraficoSemanal();

    function obterDadosGraficoSemanal() {
        fetch(`/medidas/medidas`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoSemanal(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }
    function plotarGraficoSemanal(resposta) {
        let labels = [
            'Domingo',
            'Segunda',
            'Terça',
            'Quarta',
            'Quinta',
            'Sexta',
            'Sábado'
        ];
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Ideal',
                backgroundColor: "#90BE6D",
                data: [],
            }, {
                label: 'Alerta',
                backgroundColor: "#F9C74F",
                data: [],
            }, {
                label: 'Crítico',
                backgroundColor: "#F94144",
                data: [],
            }]
        };
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)


        
        var qtdRegistrosIdeal = [0, 0, 0, 0, 0, 0, 0];
        var qtdRegistrosAlerta = [0, 0, 0, 0, 0, 0, 0];
        var qtdRegistrosCriticos = [0, 0, 0, 0, 0, 0, 0];

        // Inserindo valores no gráfico de acordo com as métricas
        for (var i = 0; i < resposta.length; i++) {
            var hoje = Number((new Date().getFullYear()) + ((new Date().getMonth() + 1).toString().padStart(2, '0')) + (new Date().getDate().toString().padStart(2, '0')));
            var dataRegistro = Number(resposta[i].dia);

            var registro = resposta[i];
            var diffDays = hoje - dataRegistro;
            var index = 6 - diffDays;

            if (registro.temperatura < 2 || registro.temperatura > 8) {
                qtdRegistrosCriticos[index]++;
            } else if (registro.temperatura <= 4.4 || registro.temperatura >= 6.6) {
                qtdRegistrosAlerta[index]++;
            } else {
                qtdRegistrosIdeal[index]++;
            }
        }
        for (var j = 0; j < 7; j++) {
            dados.datasets[0].data[j] = qtdRegistrosCriticos[j];
            dados.datasets[1].data[j] = qtdRegistrosAlerta[j];
            dados.datasets[2].data[j] = qtdRegistrosIdeal[j];
        }

        const config = {
            type: 'bar',
            data: dados,
            options: {
                scales: {
                    xAxes: [{
                        stacked: true,
                    }],
                    yAxes: [{
                        stacked: true,
                    }]
                },
            }
        };
        let myChart = new Chart(
            contextobarSemanal,
            config
        );
    }

    // DIÁRIO
    var contextopieDiaria = document.getElementById('pieDiaria').getContext('2d');
    contextopieDiaria.canvas.width = 400;
    contextopieDiaria.canvas.height = 200;
    var pieDiaria = new Chart(
        contextopieDiaria,
        {
            type: 'doughnut',
            data: {
                labels: [
                    'Ideal',
                    'Alerta',
                    'Crítico'
                ],
                datasets: [
                    {
                        data: [10, 9, 3],
                        backgroundColor: [
                            '#74A94C',
                            '#F6B213',
                            '#F81215'
                        ]
                    }
                ]
            },
            options: {
                cutoutPercentage: 70,
                legend: {
                    position: 'right',
                    align: 'middle'
                },
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10
                    }
                }
            }
        }
    );
</script>
