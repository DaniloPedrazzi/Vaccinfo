<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <!-- ChartJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>

    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/style-dashboard.css">
    <title>VaccInfo | Dashboard</title>
    
    <link rel="website icon" type="png" href="img/mini-logo.png">
</head>

<body>
    <div class="header2">
        <div class="container">
            <img src="./img/logo-vaccinfo.png" alt="">
            <div class="links">
                <div class="link">
                    <a href="perfil-usuario.html">Meu Perfil</a>
                </div>
                <div class="link">
                    <a href="./index.html">Home</a>
                </div>
                <div class="link">
                    <a href="fale conosco.html">Fale conosco</a>
                </div>
                <div class="link">
                    <a href="index.html">Sair</a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="main">
        <div class="container">
            <div class="leftSide">
                <div class="boxGrafico">
                    <div class="headerGrafico">
                        <h3>Visão Geral - Semanal</h3>
                    </div>
                    <div class="bodyGrafico">
                        <canvas id="lineSemanal"></canvas>
                    </div>
                </div>
            </div>
            <div class="rightSide">
                <div class="boxGrafico">
                    <div class="headerGrafico">
                        <h3>Visão Geral - Diária</h3>
                    </div>
                    <div class="bodyGraficoDiario">
                        <h3 class="qtdLotesTotal">23 <br> Lotes</h3>
                        <canvas id="pieDiaria"></canvas>
                    </div>
                </div>

                <div class="botoes">
                    <a href="cargas.html" class="botao botaoVermelho">
                        <div class="headerBotao">
                            <h3>Crítico</h3>
                            <img height="20px" src="./img/img-exclamacao-icon.png">
                        </div>
                        <h2>3</h2>
                    </a>
                    <a href="cargas.html" class="botao botaoAmarelo">
                        <div class="headerBotao">
                            <h3>Alerta</h3>
                            <img height="20px" src="./img/img-warn-icon.png">
                        </div>
                        <h2>9</h2>
                    </a>
                    <a href="cargas.html" class="botao botaoVerde">
                        <div class="headerBotao">
                            <h3>Ideal</h3>
                            <img height="20px" src="./img/img-check-icon.png">
                        </div>
                        <h2>10</h2>
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    // SEMANAL
    var contextolineSemanal = document.getElementById('lineSemanal').getContext('2d');
    contextolineSemanal.canvas.width = 600;
    contextolineSemanal.canvas.height = 400;
    var pieSemanal = new Chart(
        contextolineSemanal,
        {
            type: 'line',
            data: {
                labels: [
                    'Domingo',
                    'Segunda',
                    'Terça',
                    'Quarta',
                    'Quinta',
                    'Sexta',
                    'Sábado'
                ],
                datasets: [
                    {
                        label: 'Ideal',
                        data: [13, 21, 22, 20, 18, 23, 25],
                        fill: false,
                        type: 'line',
                        borderColor: ['#74A94C'],
                        backgroundColor: ['#90BE6D']
                    },
                    {
                        label: 'Alerta',
                        data: [7, 13, 10, 8, 3, 2, 15, 20],
                        fill: false,
                        type: 'line',
                        borderColor: ['#F6B213'],
                        backgroundColor: ['#F9C74F']
                    },
                    {
                        label: 'Crítico',
                        data: [3, 1, 4, 7, 3, 0, 5],
                        fill: false,
                        type: 'line',
                        borderColor: ['#F81215'],
                        backgroundColor: ['#F94144']
                    },
                ]
            },
            options: {
                scales: {
                    xAxes: [{
                        distribution: 'series',
                        ticks: {
                            beginAtZero: false
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Quantidade de Lotes'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },
                animation: {
                    duration: 0.3
                }
            }
        }
    );

    // DIÁRIO
    var contextopieDiaria = document.getElementById('pieDiaria').getContext('2d');
    contextopieDiaria.canvas.width = 400;
    contextopieDiaria.canvas.height = 200;
    var pieDiaria = new Chart(
        contextopieDiaria,
        {
            type: 'doughnut',
            data: {
                labels: [
                    'Ideal',
                    'Alerta',
                    'Crítico'
                ],
                datasets: [
                    {
                        data: [13, 7, 3],
                        backgroundColor: [
                            '#74A94C',
                            '#F6B213',
                            '#F81215'
                        ]
                    }
                ]
            },
            options: {
                cutoutPercentage: 70,
                legend: {
                    position: 'right',
                    align: 'middle'
                },
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10
                    }
                }
            }
        }
    );

    var paginacao = {};
    var tempo = {};
    function obterDados(grafico, endpoint) {
        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:3300/sensores/' + endpoint, false);
        http.send(null);
        var valores = JSON.parse(http.responseText);
        if (paginacao[endpoint] == null) {
            paginacao[endpoint] = 0;
        }
        if (tempo[endpoint] == null) {
            tempo[endpoint] = 0;
        }
        // Exibir à partir do último elemento exibido anteriormente
        var ultimaPaginacao = paginacao[endpoint];
        paginacao[endpoint] = valores.length;
        var valores = valores.slice(ultimaPaginacao);
        valores.forEach((valor) => {
            //Máximo de 60 itens exibidos no gráfico
            if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
                grafico.data.labels.shift();
                grafico.data.datasets[0].data.shift();
            }

            grafico.data.labels.push(tempo[endpoint]++);
            grafico.data.datasets[0].data.push(parseFloat(valor));
            grafico.update();
        })
    }

    setInterval(() => {
        obterDados(lm35Temperatura, 'lm35/temperatura');
    }, 1000);
</script>
